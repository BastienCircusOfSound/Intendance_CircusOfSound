<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Bars - CircusOfSound</title>
    <style>
        :root {
            --primary: #007bff;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--light);
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .app-container {
            display: none;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .nav {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .nav button {
            background: none;
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav button:hover, .nav button.active {
            background: white;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: var(--dark); }

        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section.active {
            display: block;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }

        .table th {
            background: var(--light);
            font-weight: bold;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: var(--dark); }
        .badge-danger { background: var(--danger); color: white; }
        .badge-primary { background: var(--primary); color: white; }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            display: flex;
            justify-content: space-around;
            align-items: end;
            height: 250px;
            margin: 20px 0;
            padding: 20px;
            background: var(--light);
            border-radius: 8px;
        }

        .text-center {
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            z-index: 1000;
        }

        .table-container {
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .nav {
                flex-direction: column;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- √âcran de chargement -->
    <div id="loading">
        <div>Chargement de l'application...</div>
    </div>

    <!-- √âcran de connexion -->
    <div id="login-container" class="login-container">
        <h2 class="text-center">Gestion Bars - CircusOfSound</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="username">Nom d'utilisateur:</label>
                <input type="text" id="username" required placeholder="Entrez votre nom">
            </div>
            <div class="form-group">
                <label for="password">Mot de passe:</label>
                <input type="password" id="password" required placeholder="Entrez votre mot de passe">
            </div>
            <div class="form-group">
                <label for="user-role">R√¥le:</label>
                <select id="user-role" required>
                    <option value="">S√©lectionnez votre r√¥le</option>
                    <option value="admin">Administrateur</option>
                    <option value="bar-principal">Bar Principal</option>
                    <option value="bar-terrasse">Bar Terrasse</option>
                    <option value="bar-vip">Bar VIP</option>
                    <option value="reserve">R√©serve</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
            <div id="login-error" class="alert alert-danger hidden">
                Veuillez remplir tous les champs
            </div>
        </form>
        
        <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px; font-size: 14px;">
            <strong>üß™ Version de test :</strong><br>
            Vous pouvez utiliser n'importe quel nom d'utilisateur et mot de passe pour tester l'application.
        </div>
    </div>

    <!-- Application principale -->
    <div id="app-container" class="app-container">
        <div class="header">
            <div class="container">
                <h1>Gestion Bars - CircusOfSound</h1>
                <div class="nav">
                    <button onclick="showSection('stock')" class="nav-btn active">Stock</button>
                    <button onclick="showSection('commandes')" class="nav-btn">Commandes</button>
                    <button onclick="showSection('livraisons')" class="nav-btn">Livraisons</button>
                    <button onclick="showSection('retours')" class="nav-btn">Retours</button>
                    <button onclick="showSection('rapports')" class="nav-btn">Rapports</button>
                    <button onclick="logout()" class="nav-btn">D√©connexion</button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Section Stock -->
            <div id="stock-section" class="section active">
                <h2>Gestion des Stocks</h2>
                
                <!-- Filtres -->
                <div class="grid">
                    <div class="form-group">
                        <label for="filter-categorie">Cat√©gorie:</label>
                        <select id="filter-categorie" onchange="filtrerStock()">
                            <option value="">Toutes les cat√©gories</option>
                            <option value="Bi√®re">Bi√®re</option>
                            <option value="Cocktail">Cocktail</option>
                            <option value="Soft">Soft</option>
                            <option value="Alcool">Alcool</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-search">Recherche:</label>
                        <input type="text" id="filter-search" placeholder="Nom du produit..." onkeyup="filtrerStock()">
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="showAddProductForm()">Ajouter Produit</button>
                    </div>
                </div>

                <!-- Tableau des stocks -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Cat√©gorie</th>
                                <th>Unit√©</th>
                                <th>R√©serve</th>
                                <th>Bar Principal</th>
                                <th>Bar Terrasse</th>
                                <th>Bar VIP</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stock-tbody">
                            <tr>
                                <td colspan="9" class="text-center">Chargement des produits...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section Commandes -->
            <div id="commandes-section" class="section">
                <h2>Gestion des Commandes</h2>
                
                <!-- Nouvelle commande -->
                <form id="commande-form" onsubmit="return submitCommande(this)">
                    <h3>Nouvelle Commande</h3>
                    <div class="grid">
                        <div class="form-group">
                            <label for="commande-bar">Bar:</label>
                            <select id="commande-bar" required>
                                <option value="">S√©lectionnez un bar</option>
                                <option value="bar-principal">Bar Principal</option>
                                <option value="bar-terrasse">Bar Terrasse</option>
                                <option value="bar-vip">Bar VIP</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="commande-produits">
                        <h4>Produits</h4>
                        <div class="form-group produit-commande">
                            <div style="display: grid; grid-template-columns: 3fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label>Produit:</label>
                                    <select name="produit" class="produit-select" required>
                                        <option value="">S√©lectionnez un produit</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Quantit√©:</label>
                                    <input type="number" name="quantite" min="1" value="1" required>
                                </div>
                                <div style="display: flex; align-items: end;">
                                    <button type="button" class="btn btn-danger" onclick="supprimerProduitCommande(this)">Supprimer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="ajouterProduitCommande()">Ajouter Produit</button>
                    
                    <div class="form-group">
                        <label for="commande-notes">Notes:</label>
                        <textarea id="commande-notes" rows="3" placeholder="Notes optionnelles..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Cr√©er Commande</button>
                </form>

                <!-- Liste des commandes -->
                <h3>Commandes Existantes</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Bar/Utilisateur</th>
                                <th>Produits</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="commandes-tbody">
                            <tr>
                                <td colspan="6" class="text-center">Chargement des commandes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section Livraisons -->
            <div id="livraisons-section" class="section">
                <h2>Gestion des Livraisons</h2>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Commande</th>
                                <th>Bar</th>
                                <th>Livreur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="livraisons-tbody">
                            <tr>
                                <td colspan="6" class="text-center">Chargement des livraisons...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section Retours -->
            <div id="retours-section" class="section">
                <h2>Gestion des Retours</h2>
                
                <!-- Nouveau retour -->
                <form id="retour-form" onsubmit="return submitRetour(this)">
                    <h3>Nouveau Retour</h3>
                    <div class="form-group">
                        <label for="retour-bar">Bar:</label>
                        <select id="retour-bar" required>
                            <option value="">S√©lectionnez un bar</option>
                            <option value="bar-principal">Bar Principal</option>
                            <option value="bar-terrasse">Bar Terrasse</option>
                            <option value="bar-vip">Bar VIP</option>
                        </select>
                    </div>
                    
                    <div id="retour-produits">
                        <h4>Produits √† retourner</h4>
                        <div class="form-group produit-retour">
                            <div style="display: grid; grid-template-columns: 3fr 1fr 2fr; gap: 1rem;">
                                <div>
                                    <label>Produit:</label>
                                    <select name="produit" class="produit-select" required>
                                        <option value="">S√©lectionnez un produit</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Quantit√©:</label>
                                    <input type="number" name="quantite" min="1" value="1" required>
                                </div>
                                <div>
                                    <label>Raison:</label>
                                    <select name="raison" required>
                                        <option value="non-ouvert">Non ouvert</option>
                                        <option value="defectueux">D√©fectueux</option>
                                        <option value="perime">P√©rim√©</option>
                                        <option value="erreur">Erreur de commande</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="ajouterProduitRetour()">Ajouter Produit</button>
                    
                    <div class="form-group">
                        <label for="retour-notes">Notes:</label>
                        <input type="text" name="notes" placeholder="Notes optionnelles...">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Enregistrer Retour</button>
                </form>

                <!-- Liste des retours -->
                <h3>Retours Existants</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Bar</th>
                                <th>Utilisateur</th>
                                <th>Produits</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="retours-tbody">
                            <tr>
                                <td colspan="6" class="text-center">Chargement des retours...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section Rapports -->
            <div id="rapports-section" class="section">
                <h2>Rapports et Analyses</h2>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="rapport-periode">P√©riode:</label>
                        <select id="rapport-periode">
                            <option value="jour1">Jour 1</option>
                            <option value="jour2">Jour 2</option>
                            <option value="jour3">Jour 3</option>
                            <option value="total">Total Festival</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="rapport-type">Type de rapport:</label>
                        <select id="rapport-type">
                            <option value="consommation">Consommation par Bar</option>
                            <option value="produit">Consommation par Produit</option>
                            <option value="stock">√âtat des Stocks</option>
                            <option value="commandes">Commandes et Livraisons</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="genererRapport()">G√©n√©rer Rapport</button>
                        <button class="btn btn-secondary" onclick="exporterCSV()">Exporter CSV</button>
                    </div>
                </div>

                <div id="rapport-resultat">
                    <h3 id="rapport-titre">S√©lectionnez les param√®tres et cliquez sur "G√©n√©rer Rapport"</h3>
                    
                    <div id="chart-rapport" class="chart-container">
                        <div class="text-center">Aucun rapport g√©n√©r√©</div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Bar Principal</th>
                                    <th>Bar Terrasse</th>
                                    <th>Bar VIP</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="rapport-tbody">
                                <tr>
                                    <td colspan="5" class="text-center">Aucun rapport g√©n√©r√©</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background: var(--light);">
                                    <td>TOTAUX</td>
                                    <td id="rapport-total-principal">0</td>
                                    <td id="rapport-total-terrasse">0</td>
                                    <td id="rapport-total-vip">0</td>
                                    <td id="rapport-total-global">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d'ajout/modification de produit -->
    <div id="product-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 90%; overflow-y: auto;">
            <h3 id="product-modal-title">Ajouter un Produit</h3>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label for="product-name">Nom du produit:</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label for="product-category">Cat√©gorie:</label>
                    <select id="product-category" required>
                        <option value="">S√©lectionnez une cat√©gorie</option>
                        <option value="Bi√®re">Bi√®re</option>
                        <option value="Cocktail">Cocktail</option>
                        <option value="Soft">Soft</option>
                        <option value="Alcool">Alcool</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="product-unit">Unit√©:</label>
                    <input type="text" id="product-unit" required placeholder="Ex: F√ªt 20L, Bouteille, etc.">
                </div>
                <div class="form-group">
                    <label for="product-reserve">Stock R√©serve:</label>
                    <input type="number" id="product-reserve" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="product-bar-principal">Stock Bar Principal:</label>
                    <input type="number" id="product-bar-principal" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="product-bar-terrasse">Stock Bar Terrasse:</label>
                    <input type="number" id="product-bar-terrasse" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="product-bar-vip">Stock Bar VIP:</label>
                    <input type="number" id="product-bar-vip" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="product-seuil">Seuil d'alerte:</label>
                    <input type="number" id="product-seuil" min="0" value="5">
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration Firebase - Version simplifi√©e pour les tests
        let isFirebaseAvailable = false;
        
        // Variables globales
        let currentUser = null;
        let produits = [];
        let commandes = [];
        let livraisons = [];
        let retours = [];

        // Donn√©es de test pour d√©veloppement
        const testData = {
            produits: [
                {
                    id: "test-1",
                    Nom: "Bi√®re Blonde",
                    Cat√©gorie: "Bi√®re",
                    Unit√©: "F√ªt 20L",
                    Stock_R√©serve: 10,
                    Stock_BarOne: 5,
                    Stock_BarTwo: 3,
                    Stock_BarThree: 2,
                    Seuil_Alerte: 5
                },
                {
                    id: "test-2",
                    Nom: "Coca Cola",
                    Cat√©gorie: "Soft",
                    Unit√©: "Bouteille 1.5L",
                    Stock_R√©serve: 20,
                    Stock_BarOne: 8,
                    Stock_BarTwo: 6,
                    Stock_BarThree: 4,
                    Seuil_Alerte: 10
                }
            ],
            commandes: [
                {
                    id: "CMD-test-1",
                    date: new Date().toISOString(),
                    bar: "bar-principal",
                    utilisateur: "Test User",
                    statut: "en-attente",
                    produits: [
                        { produit: "test-1", quantite: 2 }
                    ],
                    notes: "Test commande"
                }
            ]
        };

        // Fonctions utilitaires
        function getRoleName(role) {
            const roles = {
                'admin': 'Administrateur',
                'bar-principal': 'Bar Principal',
                'bar-terrasse': 'Bar Terrasse',
                'bar-vip': 'Bar VIP',
                'reserve': 'R√©serve'
            };
            return roles[role] || role;
        }

        function getCategoryName(category) {
            return category || 'N/A';
        }

        function getStatusName(status) {
            const statuses = {
                'en-attente': 'En attente',
                'en-cours': 'En cours',
                'livree': 'Livr√©e',
                'annulee': 'Annul√©e'
            };
            return statuses[status] || status;
        }

        function getRaisonRetour(raison) {
            const raisons = {
                'non-ouvert': 'Non ouvert',
                'defectueux': 'D√©fectueux',
                'perime': 'P√©rim√©',
                'erreur': 'Erreur de commande'
            };
            return raisons[raison] || raison;
        }

        // Gestion de l'authentification
        function checkAuth() {
            const savedUser = localStorage.getItem('gestionBarUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showApp();
                    loadTestData();
                    updateUIForRole();
                } catch (error) {
                    console.error("Erreur lors du chargement de l'utilisateur:", error);
                    localStorage.removeItem('gestionBarUser');
                    showLogin();
                }
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('app-container').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('gestionBarUser');
            currentUser = null;
            
            // R√©initialiser les donn√©es
            produits = [];
            commandes = [];
            livraisons = [];
            retours = [];
            
            showLogin();
        }

        function updateUIForRole() {
            if (currentUser && currentUser.role !== 'admin') {
                // Logique pour adapter l'interface selon le r√¥le
                const adminOnlyElements = document.querySelectorAll('.admin-only');
                adminOnlyElements.forEach(el => el.style.display = 'none');
            }
        }

        // Navigation
        function showSection(sectionName) {
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Masquer tous les boutons actifs
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Afficher la section s√©lectionn√©e
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // Activer le bouton correspondant
            event.target.classList.add('active');
            
            // Charger les donn√©es si n√©cessaire
            switch(sectionName) {
                case 'stock':
                    updateStockTable();
                    break;
                case 'commandes':
                    updateCommandesTable();
                    break;
                case 'livraisons':
                    updateLivraisonsTable();
                    break;
                case 'retours':
                    updateRetoursTable();
                    break;
            }
        }

        // Chargement des donn√©es de test
        function loadTestData() {
            console.log("Chargement des donn√©es de test...");
            produits = [...testData.produits];
            commandes = [...testData.commandes];
            livraisons = [];
            retours = [];
            
            updateStockTable();
            updateCommandesTable();
            updateProduitSelects();
        }

        // Gestion des produits
        function showAddProductForm() {
            document.getElementById('product-modal-title').textContent = 'Ajouter un Produit';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function editProduct(productId) {
            const produit = produits.find(p => p.id === productId);
            if (!produit) return;
            
            document.getElementById('product-modal-title').textContent = 'Modifier le Produit';
            document.getElementById('product-id').value = produit.id;
            document.getElementById('product-name').value = produit.Nom || '';
            document.getElementById('product-category').value = produit.Cat√©gorie || '';
            document.getElementById('product-unit').value = produit.Unit√© || '';
            document.getElementById('product-reserve').value = produit.Stock_R√©serve || 0;
            document.getElementById('product-bar-principal').value = produit.Stock_BarOne || 0;
            document.getElementById('product-bar-terrasse').value = produit.Stock_BarTwo || 0;
            document.getElementById('product-bar-vip').value = produit.Stock_BarThree || 0;
            document.getElementById('product-seuil').value = produit.Seuil_Alerte || 5;
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        async function saveProduct(form) {
            const productId = document.getElementById('product-id').value;
            const isNew = !productId;
            
            const produit = {
                id: isNew ? 'prod-' + Date.now() : productId,
                Nom: document.getElementById('product-name').value,
                Cat√©gorie: document.getElementById('product-category').value,
                Unit√©: document.getElementById('product-unit').value,
                Stock_R√©serve: parseInt(document.getElementById('product-reserve').value) || 0,
                Stock_BarOne: parseInt(document.getElementById('product-bar-principal').value) || 0,
                Stock_BarTwo: parseInt(document.getElementById('product-bar-terrasse').value) || 0,
                Stock_BarThree: parseInt(document.getElementById('product-bar-vip').value) || 0,
                Seuil_Alerte: parseInt(document.getElementById('product-seuil').value) || 5
            };

            try {
                if (isNew) {
                    produits.push(produit);
                    console.log("Produit ajout√©:", produit);
                } else {
                    const index = produits.findIndex(p => p.id === productId);
                    if (index !== -1) {
                        produits[index] = produit;
                        console.log("Produit mis √† jour:", produit);
                    }
                }
                
                closeProductModal();
                updateStockTable();
                updateProduitSelects();
                alert(isNew ? 'Produit ajout√© avec succ√®s!' : 'Produit mis √† jour avec succ√®s!');
            } catch (error) {
                console.error("Erreur lors de la sauvegarde:", error);
                alert("Une erreur est survenue lors de la sauvegarde.");
            }
        }

        function updateStockTable() {
            const tbody = document.getElementById('stock-tbody');
            
            if (produits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Aucun produit trouv√©. Cliquez sur "Ajouter Produit" pour commencer.</td></tr>';
                return;
            }
            
            let html = '';
            produits.forEach(produit => {
                const total = (produit.Stock_R√©serve || 0) + (produit.Stock_BarOne || 0) + (produit.Stock_BarTwo || 0) + (produit.Stock_BarThree || 0);
                const alerteClass = total <= (produit.Seuil_Alerte || 5) ? 'style="background-color: #ffe6e6;"' : '';
                
                html += `
                <tr ${alerteClass}>
                    <td>${produit.Nom || 'N/A'}</td>
                    <td>${getCategoryName(produit.Cat√©gorie || 'N/A')}</td>
                    <td>${produit.Unit√© || 'N/A'}</td>
                    <td>${produit.Stock_R√©serve || 0}</td>
                    <td>${produit.Stock_BarOne || 0}</td>
                    <td>${produit.Stock_BarTwo || 0}</td>
                    <td>${produit.Stock_BarThree || 0}</td>
                    <td><strong>${total}</strong></td>
                    <td>
                        <button class="btn btn-primary" onclick="editProduct('${produit.id}')">Ajuster</button>
                    </td>
                </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Rapports
        function genererRapport() {
            const periode = document.getElementById('rapport-periode').value;
            const type = document.getElementById('rapport-type').value;
            
            document.getElementById('rapport-titre').textContent = `${getTypeRapportName(type)} - ${getPeriodeName(periode)}`;
            
            // Logique pour g√©n√©rer le rapport selon le type
            switch(type) {
                case 'consommation':
                    genererRapportConsommation(periode);
                    break;
                case 'produit':
                    genererRapportProduit(periode);
                    break;
                case 'stock':
                    genererRapportStock();
                    break;
                case 'commandes':
                    genererRapportCommandes(periode);
                    break;
            }
        }

        function genererRapportConsommation(periode) {
            // Filtrer les livraisons selon la p√©riode
            const livraisonsPeriode = filtrerParPeriode(livraisons, periode);
            
            // Calculer la consommation par bar
            const consommationBars = {
                'bar-principal': 0,
                'bar-terrasse': 0,
                'bar-vip': 0
            };
            
            // D√©tails par produit et par bar
            const detailsProduits = {};
            
            livraisonsPeriode.forEach(livraison => {
                if (livraison.produits && Array.isArray(livraison.produits)) {
                    livraison.produits.forEach(p => {
                        // Ajouter au total du bar
                        if (consommationBars[livraison.bar] !== undefined) {
                            consommationBars[livraison.bar] += p.quantite;
                        }
                        
                        // Ajouter aux d√©tails du produit
                        if (!detailsProduits[p.produit]) {
                            detailsProduits[p.produit] = {
                                'bar-principal': 0,
                                'bar-terrasse': 0,
                                'bar-vip': 0,
                                'total': 0
                            };
                        }
                        
                        if (detailsProduits[p.produit][livraison.bar] !== undefined) {
                            detailsProduits[p.produit][livraison.bar] += p.quantite;
                            detailsProduits[p.produit].total += p.quantite;
                        }
                    });
                }
            });
            
            // Mettre √† jour le graphique
            updateRapportChart(consommationBars);
            
            // Mettre √† jour le tableau
            const tbody = document.getElementById('rapport-tbody');
            
            if (Object.keys(detailsProduits).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Aucune donn√©e disponible pour cette p√©riode</td></tr>';
                // R√©initialiser les totaux
                document.getElementById('rapport-total-principal').textContent = '0';
                document.getElementById('rapport-total-terrasse').textContent = '0';
                document.getElementById('rapport-total-vip').textContent = '0';
                document.getElementById('rapport-total-global').textContent = '0';
                return;
            }
            
            let html = '';
            for (const produitId in detailsProduits) {
                const produit = produits.find(p => p.id === produitId);
                if (produit) {
                    const details = detailsProduits[produitId];
                    html += `
                    <tr>
                        <td>${produit.Nom || 'N/A'} (${produit.Unit√© || 'N/A'})</td>
                        <td>${details['bar-principal']}</td>
                        <td>${details['bar-terrasse']}</td>
                        <td>${details['bar-vip']}</td>
                        <td>${details.total}</td>
                    </tr>
                    `;
                }
            }
            
            tbody.innerHTML = html;
            
            // Mettre √† jour les totaux
            document.getElementById('rapport-total-principal').textContent = consommationBars['bar-principal'];
            document.getElementById('rapport-total-terrasse').textContent = consommationBars['bar-terrasse'];
            document.getElementById('rapport-total-vip').textContent = consommationBars['bar-vip'];
            document.getElementById('rapport-total-global').textContent = 
                consommationBars['bar-principal'] + consommationBars['bar-terrasse'] + consommationBars['bar-vip'];
        }

        function updateRapportChart(data) {
            const chartContainer = document.getElementById('chart-rapport');
            
            // Trouver la valeur maximale pour l'√©chelle
            const maxValue = Math.max(data['bar-principal'], data['bar-terrasse'], data['bar-vip']);
            
            if (maxValue === 0) {
                chartContainer.innerHTML = '<div class="text-center">Aucune donn√©e √† afficher</div>';
                return;
            }
            
            // Calculer les hauteurs proportionnelles
            const heightPrincipal = data['bar-principal'] > 0 ? (data['bar-principal'] / maxValue * 200) : 5;
            const heightTerrasse = data['bar-terrasse'] > 0 ? (data['bar-terrasse'] / maxValue * 200) : 5;
            const heightVIP = data['bar-vip'] > 0 ? (data['bar-vip'] / maxValue * 200) : 5;
            
            chartContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div style="width: 100px; background-color: var(--primary); height: ${heightPrincipal}px; margin-bottom: 10px;"></div>
                    <div style="margin-bottom: 5px; font-weight: bold;">Bar Principal</div>
                    <div>${data['bar-principal']} unit√©s</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div style="width: 100px; background-color: var(--success); height: ${heightTerrasse}px; margin-bottom: 10px;"></div>
                    <div style="margin-bottom: 5px; font-weight: bold;">Bar Terrasse</div>
                    <div>${data['bar-terrasse']} unit√©s</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div style="width: 100px; background-color: var(--warning); height: ${heightVIP}px; margin-bottom: 10px;"></div>
                    <div style="margin-bottom: 5px; font-weight: bold;">Bar VIP</div>
                    <div>${data['bar-vip']} unit√©s</div>
                </div>
            `;
        }

        function genererRapportProduit(periode) {
            alert('Rapport par produit - Fonctionnalit√© √† venir');
        }

        function genererRapportStock() {
            alert('Rapport d\'√©tat des stocks - Fonctionnalit√© √† venir');
        }

        function genererRapportCommandes(periode) {
            alert('Rapport des commandes - Fonctionnalit√© √† venir');
        }

        function filtrerParPeriode(items, periode) {
            if (periode === 'total') {
                return items;
            }
            
            const aujourd'hui = new Date();
            const jourFestival = aujourd'hui.getDate();
            
            switch(periode) {
                case 'jour1':
                    return items.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate.getDate() === jourFestival - 2;
                    });
                case 'jour2':
                    return items.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate.getDate() === jourFestival - 1;
                    });
                case 'jour3':
                    return items.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate.getDate() === jourFestival;
                    });
                default:
                    return items;
            }
        }

        function getPeriodeName(periodeCode) {
            const periodes = {
                'jour1': 'Jour 1',
                'jour2': 'Jour 2',
                'jour3': 'Jour 3',
                'total': 'Total Festival'
            };
            
            return periodes[periodeCode] || periodeCode;
        }

        function getTypeRapportName(typeCode) {
            const types = {
                'consommation': 'Consommation par Bar',
                'produit': 'Consommation par Produit',
                'stock': 'Evolution des Stocks',
                'commandes': 'Commandes et Livraisons'
            };
            
            return types[typeCode] || typeCode;
        }

        function exporterCSV() {
            alert('Export CSV - Fonctionnalit√© √† venir');
        }

        // Initialisation de l'application
        function initApp() {
            console.log("Initialisation de l'application...");

            // G√©rer le formulaire de connexion
            document.getElementById('login-form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                const role = document.getElementById('user-role').value;
                
                // V√©rification simple
                if (username && password && role) {
                    // D√©finir l'utilisateur courant
                    currentUser = {
                        username: username,
                        role: role,
                        isAdmin: role === 'admin'
                    };
                    
                    // Enregistrer dans le localStorage
                    localStorage.setItem('gestionBarUser', JSON.stringify(currentUser));
                    
                    // Afficher l'application
                    showApp();
                    
                    // Charger les donn√©es de test
                    loadTestData();
                    
                    // Mettre √† jour l'interface
                    updateUIForRole();
                    
                    console.log("Connexion r√©ussie:", currentUser);
                } else {
                    document.getElementById('login-error').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('login-error').style.display = 'none';
                    }, 3000);
                }
            });

            // G√©rer le formulaire de produit
            document.getElementById('product-form').addEventListener('submit', function(event) {
                event.preventDefault();
                saveProduct(this);
            });

            // G√©rer le formulaire de commande
            document.getElementById('commande-form').addEventListener('submit', function(event) {
                event.preventDefault();
                submitCommande(this);
            });

            // G√©rer le formulaire de retour
            document.getElementById('retour-form').addEventListener('submit', function(event) {
                event.preventDefault();
                submitRetour(this);
            });

            // V√©rifier l'authentification au chargement
            checkAuth();

            console.log("Application initialis√©e avec succ√®s");
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM charg√©, initialisation de l'application...");
            setTimeout(() => {
                initApp();
            }, 500);
        });

        // Fallback si DOMContentLoaded ne fonctionne pas
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>;
        }

        function updateProduitSelects() {
            const selects = document.querySelectorAll('.produit-select');
            selects.forEach(select => {
                let html = '<option value="">S√©lectionnez un produit</option>';
                produits.forEach(produit => {
                    html += `<option value="${produit.id}">${produit.Nom || 'N/A'} (${produit.Unit√© || 'N/A'})</option>`;
                });
                select.innerHTML = html;
            });
        }

        function updateCommandesTable() {
            const tbody = document.getElementById('commandes-tbody');
            
            if (commandes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucune commande trouv√©e</td></tr>';
                return;
            }
            
            let html = '';
            commandes.forEach(commande => {
                const date = new Date(commande.date).toLocaleString('fr-FR');
                const barName = getRoleName(commande.bar);
                
                // Formater les produits
                let produitsList = '';
                if (commande.produits && Array.isArray(commande.produits)) {
                    commande.produits.forEach(p => {
                        const produit = produits.find(prod => prod.id === p.produit);
                        if (produit) {
                            produitsList += `${produit.Nom} (x${p.quantite}), `;
                        }
                    });
                    produitsList = produitsList.slice(0, -2);
                }
                
                // D√©finir le statut
                let statutClass = '';
                switch(commande.statut) {
                    case 'en-attente':
                        statutClass = 'badge-warning';
                        break;
                    case 'en-cours':
                        statutClass = 'badge-primary';
                        break;
                    case 'livree':
                        statutClass = 'badge-success';
                        break;
                    case 'annulee':
                        statutClass = 'badge-danger';
                        break;
                }
                
                let actions = `<button class="btn btn-primary" onclick="voirCommande('${commande.id}')">Voir</button>`;
                
                if (commande.statut === 'en-attente' && (currentUser.isAdmin || currentUser.role === 'reserve')) {
                    actions += ` <button class="btn btn-success" onclick="livrerCommande('${commande.id}')">Livrer</button>`;
                    actions += ` <button class="btn btn-danger" onclick="annulerCommande('${commande.id}')">Annuler</button>`;
                }
                
                html += `
                <tr>
                    <td>${commande.id}</td>
                    <td>${date}</td>
                    <td>${barName} (${commande.utilisateur || 'N/A'})</td>
                    <td>${produitsList}</td>
                    <td><span class="badge ${statutClass}">${getStatusName(commande.statut)}</span></td>
                    <td>${actions}</td>
                </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateLivraisonsTable() {
            const tbody = document.getElementById('livraisons-tbody');
            
            if (livraisons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucune livraison trouv√©e</td></tr>';
                return;
            }
            
            let html = '';
            livraisons.forEach(livraison => {
                const date = new Date(livraison.date).toLocaleString('fr-FR');
                const barName = getRoleName(livraison.bar);
                
                html += `
                <tr>
                    <td>${livraison.id}</td>
                    <td>${date}</td>
                    <td>${livraison.commandeId}</td>
                    <td>${barName}</td>
                    <td>${livraison.livreurId || 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="voirLivraison('${livraison.id}')">Voir</button>
                    </td>
                </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateRetoursTable() {
            const tbody = document.getElementById('retours-tbody');
            
            if (retours.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucun retour trouv√©</td></tr>';
                return;
            }
            
            let html = '';
            retours.forEach(retour => {
                const date = new Date(retour.date).toLocaleString('fr-FR');
                const barName = getRoleName(retour.bar);
                
                // Formater les produits
                let produitsList = '';
                if (retour.produits && Array.isArray(retour.produits)) {
                    retour.produits.forEach(p => {
                        const produit = produits.find(prod => prod.id === p.produit);
                        if (produit) {
                            produitsList += `${produit.Nom} (x${p.quantite}), `;
                        }
                    });
                    produitsList = produitsList.slice(0, -2);
                }
                
                html += `
                <tr>
                    <td>${retour.id}</td>
                    <td>${date}</td>
                    <td>${barName}</td>
                    <td>${retour.utilisateur || 'N/A'}</td>
                    <td>${produitsList}</td>
                    <td>
                        <button class="btn btn-primary" onclick="voirRetour('${retour.id}')">Voir</button>
                    </td>
                </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Gestion des commandes
        function ajouterProduitCommande() {
            const container = document.getElementById('commande-produits');
            
            const newProduit = document.createElement('div');
            newProduit.className = 'form-group produit-commande';
            newProduit.innerHTML = `
                <div style="display: grid; grid-template-columns: 3fr 1fr 1fr; gap: 1rem; margin-bottom: 10px;">
                    <div>
                        <label>Produit:</label>
                        <select name="produit" class="produit-select" required>
                            <option value="">S√©lectionnez un produit</option>
                            ${produits.map(p => `<option value="${p.id}">${p.Nom || 'N/A'} (${p.Unit√© || 'N/A'})</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label>Quantit√©:</label>
                        <input type="number" name="quantite" min="1" value="1" required>
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger" onclick="supprimerProduitCommande(this)">Supprimer</button>
                    </div>
                </div>
            `;
            
            container.appendChild(newProduit);
        }

        function supprimerProduitCommande(button) {
            const container = document.getElementById('commande-produits');
            if (container.children.length > 1) {
                button.closest('.produit-commande').remove();
            } else {
                alert('Vous devez garder au moins un produit dans la commande.');
            }
        }

        function submitCommande(form) {
            const bar = document.getElementById('commande-bar').value;
            const notes = document.getElementById('commande-notes').value;
            
            // R√©cup√©rer les produits
            const produitsCommande = [];
            form.querySelectorAll('.produit-commande').forEach(div => {
                const produit = div.querySelector('select[name="produit"]').value;
                const quantite = parseInt(div.querySelector('input[name="quantite"]').value);
                
                if (produit && quantite > 0) {
                    produitsCommande.push({
                        produit: produit,
                        quantite: quantite
                    });
                }
            });
            
            if (produitsCommande.length === 0) {
                alert('Veuillez ajouter au moins un produit √† votre commande.');
                return false;
            }
            
            // Cr√©er l'objet commande
            const commande = {
                id: 'CMD-' + Date.now(),
                date: new Date().toISOString(),
                bar: bar,
                utilisateur: currentUser.username,
                produits: produitsCommande,
                notes: notes,
                statut: 'en-attente'
            };
            
            try {
                commandes.push(commande);
                
                // R√©initialiser le formulaire
                form.reset();
                
                // R√©initialiser les produits (garder juste le premier)
                const produitsContainer = document.getElementById('commande-produits');
                const firstProduit = produitsContainer.querySelector('.produit-commande');
                produitsContainer.innerHTML = '';
                produitsContainer.appendChild(firstProduit);
                
                alert(`Commande ${commande.id} cr√©√©e avec succ√®s!`);
                updateCommandesTable();
            } catch (error) {
                console.error("Erreur lors de la cr√©ation de la commande:", error);
                alert("Une erreur est survenue lors de la cr√©ation de la commande.");
            }
            
            return false;
        }

        // Gestion des livraisons
        function livrerCommande(commandeId) {
            const commande = commandes.find(c => c.id === commandeId);
            if (!commande) return;
            
            if (confirm(`√ätes-vous s√ªr de vouloir marquer la commande ${commandeId} comme livr√©e ?`)) {
                try {
                    // Mettre √† jour le statut de la commande
                    commande.statut = 'livree';
                    
                    // Cr√©er la livraison
                    const livraison = {
                        id: 'LIV-' + Date.now(),
                        commandeId: commandeId,
                        date: new Date().toISOString(),
                        bar: commande.bar,
                        produits: commande.produits,
                        livreurId: currentUser.username
                    };
                    
                    livraisons.push(livraison);
                    
                    // Mettre √† jour les stocks
                    for (const p of commande.produits) {
                        const produit = produits.find(prod => prod.id === p.produit);
                        if (produit) {
                            // Soustraire de la r√©serve
                            produit.Stock_R√©serve = Math.max(0, (produit.Stock_R√©serve || 0) - p.quantite);
                            
                            // Ajouter au bar appropri√©
                            switch(commande.bar) {
                                case 'bar-principal':
                                    produit.Stock_BarOne = (produit.Stock_BarOne || 0) + p.quantite;
                                    break;
                                case 'bar-terrasse':
                                    produit.Stock_BarTwo = (produit.Stock_BarTwo || 0) + p.quantite;
                                    break;
                                case 'bar-vip':
                                    produit.Stock_BarThree = (produit.Stock_BarThree || 0) + p.quantite;
                                    break;
                            }
                        }
                    }
                    
                    alert('Commande livr√©e avec succ√®s!');
                    updateCommandesTable();
                    updateStockTable();
                    updateLivraisonsTable();
                } catch (error) {
                    console.error("Erreur lors de la livraison:", error);
                    alert("Une erreur est survenue lors de la livraison.");
                }
            }
        }

        function annulerCommande(commandeId) {
            const commande = commandes.find(c => c.id === commandeId);
            if (!commande) return;
            
            if (confirm(`√ätes-vous s√ªr de vouloir annuler la commande ${commandeId} ?`)) {
                try {
                    commande.statut = 'annulee';
                    alert('Commande annul√©e avec succ√®s!');
                    updateCommandesTable();
                } catch (error) {
                    console.error("Erreur lors de l'annulation:", error);
                    alert("Une erreur est survenue lors de l'annulation.");
                }
            }
        }

        // Gestion des retours
        function ajouterProduitRetour() {
            const container = document.getElementById('retour-produits');
            const produitIndex = container.children.length + 1;
            
            const newProduit = document.createElement('div');
            newProduit.className = 'form-group produit-retour';
            newProduit.innerHTML = `
                <h4>Produit ${produitIndex}</h4>
                <div style="display: grid; grid-template-columns: 3fr 1fr 2fr; gap: 1rem; margin-bottom: 10px;">
                    <div>
                        <label>Produit:</label>
                        <select name="produit" class="produit-select" required>
                            <option value="">S√©lectionnez un produit</option>
                            ${produits.map(p => `<option value="${p.id}">${p.Nom || 'N/A'} (${p.Unit√© || 'N/A'})</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label>Quantit√©:</label>
                        <input type="number" name="quantite" min="1" value="1" required>
                    </div>
                    <div>
                        <label>Raison:</label>
                        <select name="raison" required>
                            <option value="non-ouvert">Non ouvert</option>
                            <option value="defectueux">D√©fectueux</option>
                            <option value="perime">P√©rim√©</option>
                            <option value="erreur">Erreur de commande</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="btn btn-danger" style="margin-top: 0.5rem;" onclick="this.parentNode.remove()">Supprimer</button>
            `;
            
            container.appendChild(newProduit);
        }

        function submitRetour(form) {
            const bar = document.getElementById('retour-bar').value;
            const notes = form.querySelector('input[name="notes"]').value;
            
            // R√©cup√©rer les produits retourn√©s
            const produitsRetour = [];
            form.querySelectorAll('.produit-retour').forEach(div => {
                const produit = div.querySelector('select[name="produit"]').value;
                const quantite = parseInt(div.querySelector('input[name="quantite"]').value);
                const raison = div.querySelector('select[name="raison"]').value;
                
                if (produit && quantite > 0) {
                    produitsRetour.push({
                        produit: produit,
                        quantite: quantite,
                        raison: raison
                    });
                }
            });
            
            if (produitsRetour.length === 0) {
                alert('Veuillez ajouter au moins un produit √† votre retour.');
                return false;
            }
            
            // Cr√©er l'objet retour
            const retour = {
                id: 'RET-' + Date.now(),
                date: new Date().toISOString(),
                bar: bar,
                utilisateur: currentUser.username,
                produits: produitsRetour,
                notes: notes,
                statut: 'confirme'
            };
            
            try {
                retours.push(retour);
                
                // Mettre √† jour les stocks
                for (const p of produitsRetour) {
                    const produit = produits.find(prod => prod.id === p.produit);
                    if (produit) {
                        // Ajouter √† la r√©serve si le produit est en bon √©tat
                        if (p.raison === 'non-ouvert' || p.raison === 'erreur') {
                            produit.Stock_R√©serve = (produit.Stock_R√©serve || 0) + p.quantite;
                        }
                        
                        // Soustraire du bar appropri√©
                        switch(bar) {
                            case 'bar-principal':
                                produit.Stock_BarOne = Math.max(0, (produit.Stock_BarOne || 0) - p.quantite);
                                break;
                            case 'bar-terrasse':
                                produit.Stock_BarTwo = Math.max(0, (produit.Stock_BarTwo || 0) - p.quantite);
                                break;
                            case 'bar-vip':
                                produit.Stock_BarThree = Math.max(0, (produit.Stock_BarThree || 0) - p.quantite);
                                break;
                        }
                    }
                }
                
                // R√©initialiser le formulaire
                form.reset();
                
                // Garder uniquement le premier produit
                const produitsContainer = document.getElementById('retour-produits');
                const firstProduit = produitsContainer.firstChild;
                produitsContainer.innerHTML = '';
                produitsContainer.appendChild(firstProduit);
                
                alert(`Retour ${retour.id} enregistr√© avec succ√®s!`);
                updateRetoursTable();
                updateStockTable();
            } catch (error) {
                console.error("Erreur lors de l'enregistrement du retour:", error);
                alert("Une erreur est survenue lors de l'enregistrement du retour.");
            }
            
            return false;
        }

        // Fonctions d'affichage des d√©tails
        function voirCommande(commandeId) {
            const commande = commandes.find(c => c.id === commandeId);
            if (!commande) return;
            
            let produitsHtml = '';
            if (commande.produits && Array.isArray(commande.produits)) {
                commande.produits.forEach(p => {
                    const produit = produits.find(prod => prod.id === p.produit);
                    if (produit) {
                        produitsHtml += `‚Ä¢ ${produit.Nom || 'N/A'} (${produit.Unit√© || 'N/A'}) - Quantit√©: ${p.quantite}\n`;
                    }
                });
            }
            
            const date = new Date(commande.date).toLocaleString('fr-FR');
            const message = `D√©tails de la commande ${commande.id}

Date: ${date}
Bar: ${getRoleName(commande.bar)}
Utilisateur: ${commande.utilisateur || 'N/A'}
Statut: ${getStatusName(commande.statut)}

Produits:
${produitsHtml}

Notes: ${commande.notes || 'Aucune'}`;
            
            alert(message);
        }

        function voirLivraison(livraisonId) {
            const livraison = livraisons.find(l => l.id === livraisonId);
            if (!livraison) return;
            
            let produitsHtml = '';
            if (livraison.produits && Array.isArray(livraison.produits)) {
                livraison.produits.forEach(p => {
                    const produit = produits.find(prod => prod.id === p.produit);
                    if (produit) {
                        produitsHtml += `‚Ä¢ ${produit.Nom || 'N/A'} (${produit.Unit√© || 'N/A'}) - Quantit√©: ${p.quantite}\n`;
                    }
                });
            }
            
            const date = new Date(livraison.date).toLocaleString('fr-FR');
            const message = `D√©tails de la livraison ${livraison.id}

Date: ${date}
Commande: ${livraison.commandeId}
Bar: ${getRoleName(livraison.bar)}
Livreur: ${livraison.livreurId || 'N/A'}

Produits:
${produitsHtml}`;
            
            alert(message);
        }

        function voirRetour(retourId) {
            const retour = retours.find(r => r.id === retourId);
            if (!retour) return;
            
            let produitsHtml = '';
            if (retour.produits && Array.isArray(retour.produits)) {
                retour.produits.forEach(p => {
                    const produit = produits.find(prod => prod.id === p.produit);
                    if (produit) {
                        produitsHtml += `‚Ä¢ ${produit.Nom || 'N/A'} (${produit.Unit√© || 'N/A'}) - Quantit√©: ${p.quantite} - Raison: ${getRaisonRetour(p.raison)}\n`;
                    }
                });
            }
            
            const date = new Date(retour.date).toLocaleString('fr-FR');
            const message = `D√©tails du retour ${retour.id}

Date: ${date}
Bar: ${getRoleName(retour.bar)}
Utilisateur: ${retour.utilisateur || 'N/A'}

Produits:
${produitsHtml}

Notes: ${retour.notes || 'Aucune'}`;
            
            alert(message);
        }

        // Filtres
        function filtrerStock() {
            const categorie = document.getElementById('filter-categorie').value;
            const search = document.getElementById('filter-search').value.toLowerCase();
            
            let produitsFiltres = produits;
            
            if (categorie) {
                produitsFiltres = produitsFiltres.filter(p => p.Cat√©gorie === categorie);
            }
            
            if (search) {
                produitsFiltres = produitsFiltres.filter(p => 
                    (p.Nom || '').toLowerCase().includes(search)
                );
            }
            
            // Mettre √† jour le tableau avec les produits filtr√©s
            const tbody = document.getElementById('stock-tbody');
            
            if (produitsFiltres.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Aucun produit trouv√©</td></tr>';
                return;
            }
            
            let html = '';
            produitsFiltres.forEach(produit => {
                const total = (produit.Stock_R√©serve || 0) + (produit.Stock_BarOne || 0) + (produit.Stock_BarTwo || 0) + (produit.Stock_BarThree || 0);
                const alerteClass = total <= (produit.Seuil_Alerte || 5) ? 'style="background-color: #ffe6e6;"' : '';
                
                html += `
                <tr ${alerteClass}>
                    <td>${produit.Nom || 'N/A'}</td>
                    <td>${getCategoryName(produit.Cat√©gorie || 'N/A')}</td>
                    <td>${produit.Unit√© || 'N/A'}</td>
                    <td>${produit.Stock_R√©serve || 0}</td>
                    <td>${produit.Stock_BarOne || 0}</td>
                    <td>${produit.Stock_BarTwo || 0}</td>
                    <td>${produit.Stock_BarThree || 0}</td>
                    <td><strong>${total}</strong></td>
                    <td>
                        <button class="btn btn-primary" onclick="editProduct('${produit.id}')">Ajuster</button>
                    </td>
                </tr>
                `;
            });
            
            tbody.innerHTML = html
