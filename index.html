function voirCommande(commandeId) {
    const commande = commandes.find(c => c.id === commandeId);
    if (!commande) return;
    
    let produitsHtml = '<ul>';
    commande.produits.forEach(p => {
        const produit = produits.find(prod => prod.id === p.produit);
        if (produit) {
            produitsHtml += `<li>${produit.Nom} (${produit.Unité}) - Quantité: ${p.quantite}</li>`;
        }
    });
    produitsHtml += '</ul>';
    
    const date = new Date(commande.date).toLocaleString('fr-FR');
    const message = `
        Détails de la commande ${commande.id}
        
        Date: ${date}
        Bar: ${getRoleName(commande.bar)}
        Utilisateur: ${commande.utilisateur}
        Statut: ${getStatusName(commande.statut)}
        
        Produits:
        ${produitsHtml}
        
        Notes: ${commande.notes || 'Aucune'}
    `;
    
    alert(message);
}

// Fonctions pour les livraisons
async function livrerCommande(commandeId) {
    const commande = commandes.find(c => c.id === commandeId);
    if (!commande) return;
    
    if (confirm(`Êtes-vous sûr de vouloir marquer la commande ${commandeId} comme livrée ?`)) {
        try {
            // Mettre à jour le statut de la commande
            const commandeRef = window.firestore.doc(window.db, "commandes", commandeId);
            await window.firestore.updateDoc(commandeRef, { statut: 'livree' });
            
            // Créer la livraison
            const livraison = {
                id: 'LIV-' + Date.now(),
                commandeId: commandeId,
                date: new Date().toISOString(),
                bar: commande.bar,
                produits: commande.produits,
                livreurId: currentUser.username
            };
            
            await window.firestore.setDoc(
                window.firestore.doc(window.db, "livraisons", livraison.id),
                livraison
            );
            
            // Mettre à jour les stocks
            for (const p of commande.produits) {
                const produit = produits.find(prod => prod.id === p.produit);
                if (produit) {
                    const produitRef = window.firestore.doc(window.db, "produits", p.produit);
                    
                    // Soustraire de la réserve
                    const update = { Stock_Réserve: produit.Stock_Réserve - p.quantite };
                    
                    // Ajouter au bar approprié - Standardiser les noms de propriétés
                    switch(commande.bar) {
                        case 'bar-principal':
                            update.Stock_BarOne = produit.Stock_BarOne + p.quantite;
                            break;
                        case 'bar-terrasse':
                            update.Stock_BarTwo = produit.Stock_BarTwo + p.quantite;
                            break;
                        case 'bar-vip':
                            update.Stock_BarThree = produit.Stock_BarThree + p.quantite;
                            break;
                    }
                    
                    await window.firestore.updateDoc(produitRef, update);
                }
            }
            
            alert('Commande livrée avec succès!');
        } catch (error) {
            console.error("Erreur lors de la livraison:", error);
            alert("Une erreur est survenue lors de la livraison.");
        }
    }
}

function voirLivraison(livraisonId) {
    const livraison = livraisons.find(l => l.id === livraisonId);
    if (!livraison) return;
    
    let produitsHtml = '<ul>';
    livraison.produits.forEach(p => {
        const produit = produits.find(prod => prod.id === p.produit);
        if (produit) {
            produitsHtml += `<li>${produit.Nom} (${produit.Unité}) - Quantité: ${p.quantite}</li>`;
        }
    });
    produitsHtml += '</ul>';
    
    const date = new Date(livraison.date).toLocaleString('fr-FR');
    const message = `
        Détails de la livraison ${livraison.id}
        
        Date: ${date}
        Commande: ${livraison.commandeId}
        Bar: ${getRoleName(livraison.bar)}
        Livreur: ${livraison.livreurId}
        
        Produits:
        ${produitsHtml}
    `;
    
    alert(message);
}

// Fonctions pour les retours
function ajouterProduitRetour() {
    const produitsContainer = document.getElementById('retour-produits');
    const produitIndex = produitsContainer.children.length + 1;
    
    const newProduit = document.createElement('div');
    newProduit.className = 'form-group produit-retour';
    newProduit.innerHTML = `
        <h4>Produit ${produitIndex}</h4>
        <div style="display: grid; grid-template-columns: 3fr 1fr 2fr; gap: 1rem;">
            <div>
                <label>Produit:</label>
                <select name="produit" class="produit-select">
                    <option value="">Sélectionnez un produit</option>
                    ${produits.map(p => `<option value="${p.id}">${p.Nom} (${p.Unité})</option>`).join('')}
                </select>
            </div>
            <div>
                <label>Quantité:</label>
                <input type="number" name="quantite" min="1" value="1">
            </div>
            <div>
                <label>Raison:</label>
                <select name="raison">
                    <option value="non-ouvert">Non ouvert</option>
                    <option value="defectueux">Défectueux</option>
                    <option value="perime">Périmé</option>
                    <option value="erreur">Erreur de commande</option>
                </select>
            </div>
        </div>
        <button type="button" class="btn btn-danger" style="margin-top: 0.5rem;" onclick="this.parentNode.remove()">Supprimer</button>
    `;
    
    produitsContainer.appendChild(newProduit);
}

async function submitRetour(form) {
    // Récupérer les données du formulaire
    const bar = document.getElementById('retour-bar').value;
    const notes = form.querySelector('input[name="notes"]').value;
    
    // Récupérer les produits retournés
    const produitsRetour = [];
    form.querySelectorAll('.produit-retour').forEach(div => {
        const produit = div.querySelector('select[name="produit"]').value;
        const quantite = parseInt(div.querySelector('input[name="quantite"]').value);
        const raison = div.querySelector('select[name="raison"]').value;
        
        if (produit && quantite > 0) {
            produitsRetour.push({
                produit: produit,
                quantite: quantite,
                raison: raison
            });
        }
    });
    
    if (produitsRetour.length === 0) {
        alert('Veuillez ajouter au moins un produit à votre retour.');
        return false;
    }
    
    // Créer l'objet retour
    const retour = {
        id: 'RET-' + Date.now(),
        date: new Date().toISOString(),
        bar: bar,
        utilisateur: currentUser.username,
        produits: produitsRetour,
        notes: notes,
        statut: 'confirme'
    };
    
    try {
        // Enregistrer dans Firebase
        await window.firestore.setDoc(
            window.firestore.doc(window.db, "retours", retour.id), 
            retour
        );
        
        // Mettre à jour les stocks
        for (const p of produitsRetour) {
            const produit = produits.find(prod => prod.id === p.produit);
            if (produit) {
                const produitRef = window.firestore.doc(window.db, "produits", p.produit);
                
                // Ajouter à la réserve si le produit est en bon état
                const update = {};
                if (p.raison === 'non-ouvert' || p.raison === 'erreur') {
                    update.Stock_Réserve = produit.Stock_Réserve + p.quantite;
                }
                
                // Soustraire du bar approprié - Standardiser les noms de propriétés
                switch(bar) {
                    case 'bar-principal':
                        update.Stock_BarOne = Math.max(0, produit.Stock_BarOne - p.quantite);
                        break;
                    case 'bar-terrasse':
                        update.Stock_BarTwo = Math.max(0, produit.Stock_BarTwo - p.quantite);
                        break;
                    case 'bar-vip':
                        update.Stock_BarThree = Math.max(0, produit.Stock_BarThree - p.quantite);
                        break;
                }
                
                await window.firestore.updateDoc(produitRef, update);
            }
        }
        
        // Réinitialiser le formulaire
        form.reset();
        
        // Garder uniquement le premier produit
        const produitsContainer = document.getElementById('retour-produits');
        const firstProduit = produitsContainer.firstChild;
        produitsContainer.innerHTML = '';
        produitsContainer.appendChild(firstProduit);
        
        // Message de confirmation
        alert(`Retour ${retour.id} enregistré avec succès!`);
    } catch (error) {
        console.error("Erreur lors de l'enregistrement du retour:", error);
        alert("Une erreur est survenue lors de l'enregistrement du retour.");
    }
    
    return false;
}

function voirRetour(retourId) {
    const retour = retours.find(r => r.id === retourId);
    if (!retour) return;
    
    let produitsHtml = '<ul>';
    retour.produits.forEach(p => {
        const produit = produits.find(prod => prod.id === p.produit);
        if (produit) {
            produitsHtml += `<li>${produit.Nom} (${produit.Unité}) - Quantité: ${p.quantite} - Raison: ${getRaisonRetour(p.raison)}</li>`;
        }
    });
    produitsHtml += '</ul>';
    
    const date = new Date(retour.date).toLocaleString('fr-FR');
    const message = `
        Détails du retour ${retour.id}
        
        Date: ${date}
        Bar: ${getRoleName(retour.bar)}
        Utilisateur: ${retour.utilisateur}
        
        Produits:
        ${produitsHtml}
        
        Notes: ${retour.notes || 'Aucune'}
    `;
    
    alert(message);
}

// Fonctions pour les rapports
async function genererRapport() {
    const periode = document.getElementById('rapport-periode').value;
    const type = document.getElementById('rapport-type').value;
    
    document.getElementById('rapport-titre').textContent = `${getTypeRapportName(type)} - ${getPeriodeName(periode)}`;
    
    // Logique pour générer le rapport selon le type
    switch(type) {
        case 'consommation':
            genererRapportConsommation(periode);
            break;
        case 'produit':
            genererRapportProduit(periode);
            break;
        case 'stock':
            genererRapportStock();
            break;
        case 'commandes':
            genererRapportCommandes(periode);
            break;
    }
}

function genererRapportConsommation(periode) {
    // Filtrer les livraisons selon la période
    const livraisonsPeriode = filtrerParPeriode(livraisons, periode);
    
    // Calculer la consommation par bar
    const consommationBars = {
        'bar-principal': 0,
        'bar-terrasse': 0,
        'bar-vip': 0
    };
    
    // Détails par produit et par bar
    const detailsProduits = {};
    
    livraisonsPeriode.forEach(livraison => {
        livraison.produits.forEach(p => {
            // Ajouter au total du bar
            consommationBars[livraison.bar] += p.quantite;
            
            // Ajouter aux détails du produit
            if (!detailsProduits[p.produit]) {
                detailsProduits[p.produit] = {
                    'bar-principal': 0,
                    'bar-terrasse': 0,
                    'bar-vip': 0,
                    'total': 0
                };
            }
            
            detailsProduits[p.produit][livraison.bar] += p.quantite;
            detailsProduits[p.produit].total += p.quantite;
        });
    });
    
    // Mettre à jour le graphique
    updateRapportChart(consommationBars);
    
    // Mettre à jour le tableau
    const tbody = document.getElementById('rapport-tbody');
    
    if (Object.keys(detailsProduits).length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Aucune donnée disponible pour cette période</td></tr>';
        return;
    }
    
    let html = '';
    for (const produitId in detailsProduits) {
        const produit = produits.find(p => p.id === produitId);
        if (produit) {
            const details = detailsProduits[produitId];
            html += `
            <tr>
                <td>${produit.Nom} (${produit.Unité})</td>
                <td>${details['bar-principal']}</td>
                <td>${details['bar-terrasse']}</td>
                <td>${details['bar-vip']}</td>
                <td>${details.total}</td>
            </tr>
            `;
        }
    }
    
    tbody.innerHTML = html;
    
    // Mettre à jour les totaux
    document.getElementById('rapport-total-principal').textContent = consommationBars['bar-principal'];
    document.getElementById('rapport-total-terrasse').textContent = consommationBars['bar-terrasse'];
    document.getElementById('rapport-total-vip').textContent = consommationBars['bar-vip'];
    document.getElementById('rapport-total-global').textContent = 
        consommationBars['bar-principal'] + consommationBars['bar-terrasse'] + consommationBars['bar-vip'];
}

function updateRapportChart(data) {
    const chartContainer = document.getElementById('chart-rapport');
    
    // Trouver la valeur maximale pour l'échelle
    const maxValue = Math.max(data['bar-principal'], data['bar-terrasse'], data['bar-vip']);
    
    // Calculer les hauteurs proportionnelles
    const heightPrincipal = data['bar-principal'] > 0 ? (data['bar-principal'] / maxValue * 200) : 5;
    const heightTerrasse = data['bar-terrasse'] > 0 ? (data['bar-terrasse'] / maxValue * 200) : 5;
    const heightVIP = data['bar-vip'] > 0 ? (data['bar-vip'] / maxValue * 200) : 5;
    
    chartContainer.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="width: 100px; background-color: var(--primary); height: ${heightPrincipal}px;"></div>
            <div style="margin-top: 10px;">Bar Principal</div>
            <div>${data['bar-principal']} unités</div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="width: 100px; background-color: var(--primary); height: ${heightTerrasse}px;"></div>
            <div style="margin-top: 10px;">Bar Terrasse</div>
            <div>${data['bar-terrasse']} unités</div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="width: 100px; background-color: var(--primary); height: ${heightVIP}px;"></div>
            <div style="margin-top: 10px;">Bar VIP</div>
            <div>${data['bar-vip']} unités</div>
        </div>
    `;
}

function genererRapportProduit(periode) {
    // Implémentation similaire mais orientée produit
    alert('Rapport par produit - Fonctionnalité à venir');
}

function genererRapportStock() {
    // Rapport sur l'état actuel des stocks
    alert('Rapport d\'état des stocks - Fonctionnalité à venir');
}

function genererRapportCommandes(periode) {
    // Rapport sur les commandes
    alert('Rapport des commandes - Fonctionnalité à venir');
}

function filtrerParPeriode(items, periode) {
    if (periode === 'total') {
        return items;
    }
    
    const aujourd'hui = new Date();
    const jourFestival = aujourd'hui.getDate();
    
    switch(periode) {
        case 'jour1':
            return items.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getDate() === jourFestival - 2;
            });
        case 'jour2':
            return items.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getDate() === jourFestival - 1;
            });
        case 'jour3':
            return items.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getDate() === jourFestival;
            });
        default:
            return items;
    }
}

function getPeriodeName(periodeCode) {
    const periodes = {
        'jour1': 'Jour 1',
        'jour2': 'Jour 2',
        'jour3': 'Jour 3',
        'total': 'Total Festival'
    };
    
    return periodes[periodeCode] || periodeCode;
}

function getTypeRapportName(typeCode) {
    const types = {
        'consommation': 'Consommation par Bar',
        'produit': 'Consommation par Produit',
        'stock': 'Evolution des Stocks',
        'commandes': 'Commandes et Livraisons'
    };
    
    return types[typeCode] || typeCode;
}

function exporterCSV() {
    // Fonctionnalité d'export CSV
    alert('Export CSV - Fonctionnalité à venir');
}

// Fonctions de filtre
function filtrerStock() {
    const categorie = document.getElementById('filter-categorie').value;
    const search = document.getElementById('filter-search').value.toLowerCase();
    
    let produitsFiltres = produits;
    
    if (categorie) {
        produitsFiltres = produitsFiltres.filter(p => p.Catégorie === categorie);
    }
    
    if (search) {
        produitsFiltres = produitsFiltres.filter(p => p.Nom.toLowerCase().includes(search));
    }
    
    const stockTbody = document.getElementById('stock-tbody');
    
    if (produitsFiltres.length === 0) {
        stockTbody.innerHTML = '<tr><td colspan="9" class="text-center">Aucun produit trouvé</td></tr>';
        return;
    }
    
    let html = '';
    produitsFiltres.forEach(produit => {
        const total = produit.Stock_Réserve + produit.Stock_BarOne + produit.Stock_BarTwo + produit.Stock_BarThree;
        html += `
        <tr>
            <td>${produit.Nom}</td>
            <td>${getCategoryName(produit.Catégorie)}</td>
            <td>${produit.Unité}</td>
            <td>${produit.Stock_Réserve}</td>
            <td>${produit.Stock_BarOne}</td>
            <td>${produit.Stock_BarTwo}</td>
            <td>${produit.Stock_BarThree}</td>
            <td>${total}</td>
            <td>
                <button class="btn btn-primary" onclick="editProduct('${produit.id}')">Ajuster</button>
            </td>
        </tr>
        `;
    });
    
    stockTbody.innerHTML = html;
}

function filtrerCommandes() {
    const bar = document.getElementById('filter-commande-bar').value;
    const user = document.getElementById('filter-commande-user').value;
    const statut = document.getElementById('filter-commande-statut').value;
    
    let commandesFiltrees = commandes;
    
    if (bar) {
        commandesFiltrees = commandesFiltrees.filter(c => c.bar === bar);
    }
    
    if (user) {
        commandesFiltrees = commandesFiltrees.filter(c => c.utilisateur === user);
    }
    
    if (statut) {
        commandesFiltrees = commandesFiltrees.filter(c => c.statut === statut);
    }
    
    const commandesTbody = document.getElementById('commandes-tbody');
    
    if (commandesFiltrees.length === 0) {
        commandesTbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucune commande trouvée</td></tr>';
        return;
    }
    
    let html = '';
    commandesFiltrees.forEach(commande => {
        const date = new Date(commande.date).toLocaleString('fr-FR');
        const barName = getRoleName(commande.bar);
        
        // Formater les produits
        let produitsList = '';
        commande.produits.forEach(p => {
            const produit = produits.find(prod => prod.id === p.produit);
            if (produit) {
                produitsList += `${produit.Nom} (x${p.quantite}), `;
            }
        });
        produitsList = produitsList.slice(0, -2);
        
        // Définir le statut
        let statutClass = '';
        switch(commande.statut) {
            case 'en-attente':
                statutClass = 'badge-warning';
                break;
            case 'en-cours':
                statutClass = 'badge-primary';
                break;
            case 'livree':
                statutClass = 'badge-success';
                break;
            case 'annulee':
                statutClass = 'badge-danger';
                break;
        }
        
        let actions = `<button class="btn btn-primary" onclick="voirCommande('${commande.id}')">Voir</button>`;
        
        if (commande.statut === 'en-attente') {
            actions += ` <button class="btn btn-danger" onclick="annulerCommande('${commande.id}')">Annuler</button>`;
        }
        
        html += `
        <tr>
            <td>${commande.id}</td>
            <td>${date}</td>
            <td>${barName} (${commande.utilisateur})</td>
            <td>${produitsList}</td>
            <td><span class="badge ${statutClass}">${getStatusName(commande.statut)}</span></td>
            <td>${actions}</td>
        </tr>
        `;
    });
    
    commandesTbody.innerHTML = html;
}

// Événements au chargement du document
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier l'authentification au chargement
    checkAuth();
    
    // Gérer le formulaire de connexion
    document.getElementById('login-form').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('user-role').value;
        
        // Vérification simple (à remplacer par une authentification Firebase)
        if (username && password && role) {
            // Définir l'utilisateur courant
            currentUser = {
                username: username,
                role: role,
                isAdmin: role === 'admin'
            };
            
            // Enregistrer dans le localStorage pour "persister" la session
            localStorage.setItem('gestionBarUser', JSON.stringify(currentUser));
            
            // Afficher l'application
            showApp();
            
            // Initialiser les données
            initFirebaseListeners();
            
            // Mettre à jour l'interface
            updateUIForRole();
        } else {
            document.getElementById('login-error').style.display = 'block';
        }
    });
    
    // Gérer la soumission du formulaire de produit
    const addProductForm = document.getElementById('add-product-form');
    if (addProductForm) {
        addProductForm.addEventListener('submit', function(event) {
            event.preventDefault();
            saveProduct(this);
        });
    }
});
